<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>ScheduleController.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cs5200-spring2018-nandu</a> &gt; <a href="index.source.html" class="el_package">edu.northeastern.cs5500.jobs</a> &gt; <span class="el_source">ScheduleController.java</span></div><h1>ScheduleController.java</h1><pre class="source lang-java linenums">package edu.northeastern.cs5500.jobs;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import edu.northeastern.cs5500.Constants;
import edu.northeastern.cs5500.controller.notification.NotificationService;
import edu.northeastern.cs5500.controller.result.ResultsService;
import edu.northeastern.cs5500.controller.snapshot.SnapshotService;
import edu.northeastern.cs5500.controller.user.UserService;
import edu.northeastern.cs5500.mail.MailClient;
import edu.northeastern.cs5500.models.person.User;
import edu.northeastern.cs5500.models.snapshot.Snapshot;
import edu.northeastern.cs5500.models.submission.Submission;


@Component
<span class="fc" id="L21">public class ScheduleController {</span>
	
	@Autowired
	private SnapshotService snapshotService;
	
	@Autowired
	private NotificationService notificationService;
	
	
	@Autowired
	private ResultsService resultsService;

	@Autowired
	private MailClient mail;

	@Autowired
	private UserService userService;

	int t;
	private Logger log;
	
	
	/**
	 * Run method
	 */
	@Scheduled(cron = &quot;0 0/2 * 1/1 * ?&quot;)
	public void run() {
<span class="fc" id="L48">		log = Logger.getAnonymousLogger();</span>
<span class="fc" id="L49">		log.log(Level.INFO, &quot;Running&quot;);</span>
<span class="fc" id="L50">		List&lt;Snapshot&gt; list = this.snapshotService.getAllSnapshotsToBePerformed();</span>
<span class="fc" id="L51">		boolean flag = false;</span>
<span class="pc bpc" id="L52" title="1 of 2 branches missed.">		for(Snapshot snap : list) {</span>
<span class="nc" id="L53">			this.snapshotService.updateStatus(snap.getId(), -1);</span>
<span class="nc" id="L54">			log.log(Level.INFO, &quot;Type: &quot; + snap.getType());</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">			if(snap.getType() == 0) {</span>
<span class="nc" id="L56">				flag = calculateIncrementalResult(snap.getId());</span>
<span class="nc" id="L57">				t = snap.getId();</span>
<span class="nc" id="L58">				sendMail(2);</span>
<span class="nc" id="L59">				sendNotification(snap.getType());</span>
			}else {
<span class="nc" id="L61">				flag = calculateTotalResult(snap.getId());</span>
<span class="nc" id="L62">				log.log(Level.INFO, &quot;Sending Mail&quot;);</span>
<span class="nc" id="L63">				t = snap.getId();</span>
<span class="nc" id="L64">				sendMail(snap.getId());</span>
<span class="nc" id="L65">				sendNotification(snap.getType());</span>
			}
<span class="nc bnc" id="L67" title="All 2 branches missed.">			if(flag)</span>
<span class="nc" id="L68">				this.snapshotService.updateStatus(snap.getId(), 1);</span>
<span class="nc" id="L69">		}</span>
<span class="fc" id="L70">	}</span>
	
	/**
	 * Send Notification
	 */
	private void sendNotification(int type) {
<span class="nc" id="L76">		String text = &quot;Your requested report is now generated&quot;;</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">		if(type == 0) {</span>
<span class="nc" id="L78">			text = &quot;A student submission triggered the report&quot;;</span>
		}
<span class="nc" id="L80">		this.notificationService.addNotification(text, t);</span>
<span class="nc" id="L81">	}</span>
	
	
	/**
	 * 
	 * @param snapId
	 */
	private void sendMail(int snapId) {
<span class="nc" id="L89">		User user = this.userService.getUserId(snapId);</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">		if(user == null)</span>
<span class="nc" id="L91">			return;</span>
<span class="nc" id="L92">		mail.sendSimpleMessage(user.getEmail(), &quot;Plag Detector Report&quot;, &quot;Hello\nThe plag report was generated on &quot; + </span>
<span class="nc" id="L93">			Constants.getCurrentDate() + &quot;.\nYou can log in now and check the report using the following link,\nhttp://ec2-18-220-236-121.us-east-2.compute.amazonaws.com:8080/#!/results/&quot;+t+&quot;.\nThank You!\nAdmin&quot;);</span>
<span class="nc" id="L94">	}</span>
	
	/**
	 * 
	 * @param list
	 * @return
	 */
	private int findMaxSubmission(List&lt;Submission&gt; list) {
<span class="nc" id="L102">		int max = -1;</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">		for(Submission s: list) {</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">			if(max &lt; s.getId()) {</span>
<span class="nc" id="L105">				max = s.getId();</span>
			}
<span class="nc" id="L107">		}</span>
<span class="nc" id="L108">		return max;</span>
	}
	
	/**
	 * 
	 * @param id
	 * @return
	 */
	private boolean calculateIncrementalResult(int id) {
<span class="nc" id="L117">		List&lt;Submission&gt; submissions = this.snapshotService.getAllSubmissionsForSnapshot(id);</span>
<span class="nc bnc" id="L118" title="All 2 branches missed.">		if(submissions.size() == 1)</span>
<span class="nc" id="L119">			return false;</span>
<span class="nc" id="L120">		int max = this.findMaxSubmission(submissions);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">		if(max == -1)</span>
<span class="nc" id="L122">			return false;</span>

<span class="nc bnc" id="L124" title="All 2 branches missed.">		for(Submission s : submissions) {</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">			if(s.getId() != max) {</span>
<span class="nc" id="L126">				this.resultsService.deleteEntries(max, s.getId());</span>
<span class="nc" id="L127">				resultsService.findResults(max, s.getId());</span>
			}
<span class="nc" id="L129">		}</span>
<span class="nc" id="L130">		return true;</span>
	}
	
	/**
	 * 
	 * @param id
	 * @return
	 */
	private boolean calculateTotalResult(int id) {
<span class="nc" id="L139">		List&lt;Submission&gt; submissions = this.snapshotService.getAllSubmissionsForSnapshot(id);</span>
		try {
<span class="nc bnc" id="L141" title="All 2 branches missed.">			for(int i = 0;i&lt;submissions.size();++i) {</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">				for(int j = i + 1;j&lt;submissions.size();++j) {</span>
<span class="nc" id="L143">					this.resultsService.deleteEntries(submissions.get(i).getId(), submissions.get(j).getId());</span>
<span class="nc" id="L144">					resultsService.findResults(submissions.get(i).getId(), submissions.get(j).getId());</span>
				}
			}
<span class="nc" id="L147">		}catch(Exception e) {</span>
<span class="nc" id="L148">			log.log(Level.INFO, e.getMessage());</span>
<span class="nc" id="L149">			return false;</span>
<span class="nc" id="L150">		}</span>
<span class="nc" id="L151">		return true;</span>
	}
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>